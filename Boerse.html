<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Handball Zeitnehmer-Börse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container {
            max-width: 800px;
        }
        .modal {
            display: none;
        }
        .modal.active {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div id="app" class="bg-white rounded-xl shadow-lg p-6 w-full container">

        <!-- Lade- und Authentifizierungsanzeige -->
        <div id="loading" class="text-center text-gray-500 mb-4">Lade...</div>
        <div id="user-info" class="text-xs text-gray-500 text-center mb-6 hidden">
            <span>Deine User-ID: </span><span id="user-id-display" class="font-mono"></span>
        </div>

        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Zeitnehmer-Börse</h1>
        <p class="text-center text-gray-600 mb-8">Biete oder übernehme eine Schicht.</p>

        <!-- Formular zum Hinzufügen eines Termins -->
        <div class="bg-blue-50 rounded-lg p-5 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-blue-800">Schicht anbieten</h2>
            <form id="shift-form" class="space-y-4">
                <input id="game-name" type="text" placeholder="Spiel (z.B. TSG vs. SG)" required
                       class="w-full px-4 py-2 border rounded-md focus:ring focus:ring-blue-200">
                <input id="shift-date" type="date" required
                       class="w-full px-4 py-2 border rounded-md focus:ring focus:ring-blue-200">
                <input id="shift-time" type="time" required
                       class="w-full px-4 py-2 border rounded-md focus:ring focus:ring-blue-200">
                <button type="submit"
                        class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                    Schicht anbieten
                </button>
            </form>
        </div>

        <!-- Liste der verfügbaren Termine -->
        <div class="bg-green-50 rounded-lg p-5">
            <h2 class="text-xl font-semibold mb-4 text-green-800">Verfügbare Schichten</h2>
            <ul id="shifts-list" class="space-y-3">
                <!-- Dynamisch erzeugte Schicht-Elemente -->
                <li id="no-shifts" class="text-center text-gray-500 py-4 hidden">Aktuell keine Schichten verfügbar.</li>
            </ul>
        </div>

        <!-- Eigenes Modal für Bestätigungen -->
        <div id="confirmation-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 justify-center items-center p-4">
            <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
                <h3 id="modal-title" class="text-lg font-bold mb-4">Termin übernehmen?</h3>
                <p id="modal-message" class="mb-4">Möchtest du diesen Termin wirklich übernehmen?</p>
                <div class="flex justify-end space-x-2">
                    <button id="modal-cancel" class="px-4 py-2 rounded-md border border-gray-300 text-gray-700 hover:bg-gray-100">Abbrechen</button>
                    <button id="modal-confirm" class="px-4 py-2 rounded-md bg-green-500 text-white hover:bg-green-600">Bestätigen</button>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase- und App-Skripte -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase-Konfiguration
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId;

        const loadingIndicator = document.getElementById('loading');
        const appContainer = document.getElementById('app');
        const shiftsList = document.getElementById('shifts-list');
        const noShiftsMessage = document.getElementById('no-shifts');
        const userInfoDisplay = document.getElementById('user-info');
        const userIdDisplay = document.getElementById('user-id-display');

        // Modal-Elemente
        const modal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm');
        const modalCancelBtn = document.getElementById('modal-cancel');
        let currentShiftIdToDelete = null;

        // Funktion zum Anzeigen des Modals
        function showModal(title, message, onConfirm, onCancel) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalConfirmBtn.onclick = onConfirm;
            modalCancelBtn.onclick = onCancel;
            modal.classList.add('active');
        }

        // Funktion zum Verstecken des Modals
        function hideModal() {
            modal.classList.remove('active');
        }

        // Firebase-Initialisierung und Authentifizierung
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser.uid;
                    
                    loadingIndicator.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    userInfoDisplay.classList.remove('hidden');
                    userIdDisplay.textContent = userId;

                    listenForShifts();
                } else {
                    console.error("Firebase Config is not defined. The app will not be able to connect to Firestore.");
                }
            } catch (error) {
                console.error("Fehler bei der Firebase-Initialisierung oder Authentifizierung:", error);
            }
        }

        // Echtzeit-Update der Schicht-Liste
        function listenForShifts() {
            const shiftsCollection = collection(db, `artifacts/${appId}/public/data/shifts`);
            onSnapshot(shiftsCollection, (snapshot) => {
                const shifts = [];
                snapshot.forEach(doc => {
                    shifts.push({ id: doc.id, ...doc.data() });
                });
                renderShifts(shifts);
            }, (error) => {
                console.error("Fehler beim Abrufen der Schichten:", error);
            });
        }

        // Schichten in der UI rendern
        function renderShifts(shifts) {
            shiftsList.innerHTML = '';
            if (shifts.length === 0) {
                noShiftsMessage.classList.remove('hidden');
            } else {
                noShiftsMessage.classList.add('hidden');
                shifts.forEach(shift => {
                    const li = document.createElement('li');
                    li.className = 'bg-white rounded-lg p-4 shadow-sm flex items-center justify-between';
                    li.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-800">${shift.gameName}</p>
                            <p class="text-sm text-gray-600">${shift.shiftDate} um ${shift.shiftTime}</p>
                            <p class="text-xs text-gray-400 mt-1">Angeboten von: ${shift.offeredBy.substring(0, 8)}...</p>
                        </div>
                        <button data-id="${shift.id}" class="take-shift-btn bg-green-500 text-white font-bold py-2 px-4 rounded-md hover:bg-green-600 transition-colors">
                            Übernehmen
                        </button>
                    `;
                    shiftsList.appendChild(li);
                });
            }
        }
        
        // Event-Listener für das Formular
        document.getElementById('shift-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const gameName = document.getElementById('game-name').value;
            const shiftDate = document.getElementById('shift-date').value;
            const shiftTime = document.getElementById('shift-time').value;

            if (!db) {
                console.error("Datenbank nicht initialisiert.");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/shifts`), {
                    gameName,
                    shiftDate,
                    shiftTime,
                    offeredBy: userId,
                    createdAt: new Date()
                });
                document.getElementById('shift-form').reset();
            } catch (error) {
                console.error("Fehler beim Hinzufügen des Termins:", error);
            }
        });

        // Event-Listener für das Übernehmen von Terminen
        shiftsList.addEventListener('click', (e) => {
            const btn = e.target.closest('.take-shift-btn');
            if (btn) {
                currentShiftIdToDelete = btn.dataset.id;
                showModal(
                    'Schicht übernehmen?',
                    'Bist du sicher, dass du diese Schicht übernehmen möchtest?',
                    () => handleTakeShift(currentShiftIdToDelete),
                    hideModal
                );
            }
        });

        // Schicht übernehmen
        async function handleTakeShift(shiftId) {
            if (!db) {
                console.error("Datenbank nicht initialisiert.");
                hideModal();
                return;
            }
            try {
                const shiftRef = doc(db, `artifacts/${appId}/public/data/shifts`, shiftId);
                const shiftSnap = await getDoc(shiftRef);

                if (shiftSnap.exists()) {
                    await deleteDoc(shiftRef);
                    // Hier könntest du eine Benachrichtigung hinzufügen, z.B. eine Toast-Nachricht
                    console.log("Schicht erfolgreich übernommen!");
                } else {
                    console.log("Diese Schicht wurde bereits von jemand anderem übernommen.");
                }
            } catch (error) {
                console.error("Fehler beim Übernehmen der Schicht:", error);
            } finally {
                hideModal();
            }
        }
        
        initializeFirebase();
    </script>
</body>
</html>
